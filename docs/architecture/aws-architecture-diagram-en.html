<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KnowledgeWeaver AWS Architecture</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 40px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        #diagram {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node:hover {
            transform: translateY(-2px);
        }

        .node rect, .node ellipse, .node polygon {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        .node text {
            pointer-events: none;
            font-weight: 600;
        }

        .link {
            fill: none;
            stroke-width: 2.5;
            opacity: 0.7;
        }

        .link.solid {
            stroke: #FF6A88;
        }

        .link.dashed {
            stroke: #FF9A56;
            stroke-dasharray: 8, 4;
        }

        .group-box {
            fill: none;
            stroke-width: 2;
            rx: 15;
            opacity: 0.8;
        }

        .group-box.vpc {
            stroke: #232F3E;
            stroke-dasharray: 10, 5;
        }

        .group-box.subnet {
            stroke: #4A90E2;
            stroke-dasharray: 5, 3;
        }

        .group-box.services {
            stroke: #E07B39;
            stroke-dasharray: 10, 5;
        }

        .group-box.cluster {
            stroke: #FF9900;
            stroke-dasharray: 8, 4;
        }

        .group-label {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .group-label.vpc {
            fill: #232F3E;
        }

        .group-label.subnet {
            fill: #4A90E2;
        }

        .group-label.services {
            fill: #E07B39;
        }

        .group-label.cluster {
            fill: #FF9900;
        }

        .title {
            font-size: 32px;
            font-weight: 700;
            fill: #333;
            text-anchor: middle;
        }

        .subtitle {
            font-size: 16px;
            fill: #666;
            text-anchor: middle;
        }

        .arrow {
            fill: #FF6A88;
        }

        .arrow.dashed {
            fill: #FF9A56;
        }

        .aws-icon {
            font-size: 12px;
            fill: #FF9900;
            font-weight: 700;
        }

        /* Download button */
        .download-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: all 0.2s;
            z-index: 1000;
        }

        .download-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
            transform: translateY(-2px);
        }

        .download-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <button class="download-btn" onclick="downloadDiagram()">ðŸ“¥ Download PNG</button>
    <div id="diagram"></div>

    <script>
        const width = 1600;
        const height = 850;

        const svg = d3.select('#diagram')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Define arrow markers
        svg.append('defs').selectAll('marker')
            .data(['arrow', 'arrow-dashed'])
            .enter().append('marker')
            .attr('id', d => d)
            .attr('viewBox', '0 0 10 10')
            .attr('refX', 9)
            .attr('refY', 5)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M 0 0 L 10 5 L 0 10 z')
            .attr('class', d => d === 'arrow-dashed' ? 'arrow dashed' : 'arrow');

        // Title
        svg.append('text')
            .attr('class', 'title')
            .attr('x', width / 2)
            .attr('y', 40)
            .text('KnowledgeWeaver AWS Cloud Architecture');

        svg.append('text')
            .attr('class', 'subtitle')
            .attr('x', width / 2)
            .attr('y', 65)
            .text('EKS Kubernetes Production Deployment');

        // Define colors (AWS-inspired)
        const colors = {
            // Networking
            vpc: '#232F3E',
            subnet: '#4A90E2',
            alb: '#8C4FFF',
            nat: '#527FFF',
            igw: '#2E7D32',

            // Compute
            eks: '#FF9900',
            node: '#FF6F00',
            pod: '#FFA500',

            // Storage
            s3: '#569A31',
            ebs: '#527FFF',

            // Management
            cloudwatch: '#FF4F8B',
            secrets: '#DD344C',
            cloudtrail: '#DD344C',

            // Application
            api: '#FF6A88',
            neo4j: '#008CC1',
            phoenix: '#9C27B0',
            postgres: '#336791',

            // External
            internet: '#4CAF50',
            user: '#2196F3'
        };

        // Group definitions
        const groups = [
            // VPC
            {id: 'vpc', x: 40, y: 100, width: 1050, height: 700, label: 'VPC (10.0.0.0/16)', class: 'vpc'},

            // Public Subnet
            {id: 'public', x: 60, y: 140, width: 320, height: 240, label: 'PUBLIC SUBNET (10.0.1.0/24)', class: 'subnet'},

            // Private Subnet
            {id: 'private', x: 60, y: 400, width: 1010, height: 380, label: 'PRIVATE SUBNET (10.0.2.0/24)', class: 'subnet'},

            // EKS Cluster
            {id: 'eks-cluster', x: 80, y: 440, width: 970, height: 320, label: 'EKS CLUSTER (Kubernetes 1.28)', class: 'cluster'},

            // AWS Managed Services
            {id: 'services', x: 1120, y: 100, width: 440, height: 700, label: 'AWS MANAGED SERVICES', class: 'services'}
        ];

        // Draw groups
        svg.selectAll('.group-box')
            .data(groups)
            .enter().append('rect')
            .attr('class', d => `group-box ${d.class}`)
            .attr('x', d => d.x)
            .attr('y', d => d.y)
            .attr('width', d => d.width)
            .attr('height', d => d.height);

        svg.selectAll('.group-label')
            .data(groups)
            .enter().append('text')
            .attr('class', d => `group-label ${d.class}`)
            .attr('x', d => d.x + 10)
            .attr('y', d => d.y - 8)
            .text(d => d.label);

        // Node definitions
        const nodes = [
            // Public Subnet Components
            {id: 'alb', x: 120, y: 190, width: 160, height: 65, label: 'Application Load\nBalancer (ALB)', color: colors.alb},
            {id: 'nat', x: 140, y: 290, width: 120, height: 55, label: 'NAT Gateway', color: colors.nat},

            // Worker Nodes (in EKS Cluster)
            {id: 'node1', x: 100, y: 490, width: 200, height: 80, label: 'Worker Node 1\nt3.medium', color: colors.node},
            {id: 'node2', x: 330, y: 490, width: 200, height: 80, label: 'Worker Node 2\nt3.medium', color: colors.node},

            // Pods on Node 1
            {id: 'api-pod1', x: 160, y: 610, width: 90, height: 70, label: 'API Pod\n(FastAPI)', color: colors.api},

            // Pods on Node 2
            {id: 'neo4j-pod', x: 350, y: 610, width: 80, height: 70, label: 'Neo4j\nPod', color: colors.neo4j, shape: 'cylinder'},
            {id: 'phoenix-pod', x: 450, y: 610, width: 80, height: 70, label: 'Phoenix\nPod', color: colors.phoenix},

            // Storage Pods
            {id: 'postgres-pod', x: 570, y: 610, width: 100, height: 70, label: 'PostgreSQL\nPod', color: colors.postgres, shape: 'cylinder'},
            {id: 'ebs', x: 750, y: 610, width: 140, height: 70, label: 'EBS Volumes\n(Persistent)', color: colors.ebs, shape: 'cylinder'},

            // AWS Managed Services (right side)
            {id: 's3', x: 1160, y: 150, width: 170, height: 70, label: 'S3 Bucket\n(Documents)', color: colors.s3, shape: 'cylinder'},
            {id: 'ecr', x: 1360, y: 150, width: 160, height: 70, label: 'ECR\n(Images)', color: colors.eks, shape: 'cylinder'},
            {id: 'cloudwatch', x: 1160, y: 320, width: 170, height: 70, label: 'CloudWatch\nLogs & Metrics', color: colors.cloudwatch},
            {id: 'secrets', x: 1360, y: 320, width: 160, height: 70, label: 'Secrets\nManager', color: colors.secrets},
            {id: 'cloudtrail', x: 1160, y: 490, width: 170, height: 70, label: 'CloudTrail\n(Audit Logs)', color: colors.cloudtrail}
        ];

        // Draw nodes
        const nodeGroup = svg.selectAll('.node')
            .data(nodes)
            .enter().append('g')
            .attr('class', 'node')
            .attr('transform', d => `translate(${d.x}, ${d.y})`);

        nodeGroup.each(function(d) {
            const node = d3.select(this);

            if (d.shape === 'cylinder') {
                // Cylinder shape (databases/storage)
                const rx = d.width / 2;
                const ry = 8;

                node.append('ellipse')
                    .attr('cx', d.width / 2)
                    .attr('cy', ry)
                    .attr('rx', rx)
                    .attr('ry', ry)
                    .attr('fill', d.color)
                    .attr('stroke', d3.rgb(d.color).darker(0.5))
                    .attr('stroke-width', 2);

                node.append('rect')
                    .attr('x', 0)
                    .attr('y', ry)
                    .attr('width', d.width)
                    .attr('height', d.height - ry)
                    .attr('fill', d.color)
                    .attr('stroke', d3.rgb(d.color).darker(0.5))
                    .attr('stroke-width', 2);

                node.append('ellipse')
                    .attr('cx', d.width / 2)
                    .attr('cy', d.height)
                    .attr('rx', rx)
                    .attr('ry', ry)
                    .attr('fill', d.color)
                    .attr('stroke', d3.rgb(d.color).darker(0.5))
                    .attr('stroke-width', 2);

            } else if (d.shape === 'hexagon') {
                // Hexagon shape (external services)
                const points = [
                    [20, 0],
                    [d.width - 20, 0],
                    [d.width, d.height / 2],
                    [d.width - 20, d.height],
                    [20, d.height],
                    [0, d.height / 2]
                ];

                node.append('polygon')
                    .attr('points', points.map(p => p.join(',')).join(' '))
                    .attr('fill', d.color)
                    .attr('stroke', d3.rgb(d.color).darker(0.5))
                    .attr('stroke-width', 2);

            } else {
                // Rectangle (default)
                node.append('rect')
                    .attr('width', d.width)
                    .attr('height', d.height)
                    .attr('rx', 8)
                    .attr('fill', d.color)
                    .attr('stroke', d3.rgb(d.color).darker(0.5))
                    .attr('stroke-width', 2);
            }

            // Add text
            const lines = d.label.split('\n');
            const textGroup = node.append('text')
                .attr('x', d.width / 2)
                .attr('y', d.height / 2)
                .attr('text-anchor', 'middle')
                .attr('dominant-baseline', 'central')
                .attr('fill', 'white')
                .attr('font-size', '11px');

            const lineHeight = 13;
            const startY = -(lines.length - 1) * lineHeight / 2;
            lines.forEach((line, i) => {
                textGroup.append('tspan')
                    .attr('x', d.width / 2)
                    .attr('dy', i === 0 ? startY : lineHeight)
                    .text(line);
            });
        });

        // Links
        const links = [
            // ALB to API pod
            {from: 'alb', to: 'api-pod1', type: 'solid'},

            // Nodes to Pods
            {from: 'node1', to: 'api-pod1', type: 'solid'},
            {from: 'node2', to: 'neo4j-pod', type: 'solid'},
            {from: 'node2', to: 'phoenix-pod', type: 'solid'},
            {from: 'node2', to: 'postgres-pod', type: 'solid'},

            // Pods to Storage
            {from: 'neo4j-pod', to: 'ebs', type: 'solid'},
            {from: 'postgres-pod', to: 'ebs', type: 'solid'},

            // API pod to Neo4j
            {from: 'api-pod1', to: 'neo4j-pod', type: 'dashed'},

            // NAT Gateway
            {from: 'node1', to: 'nat', type: 'dashed'},

            // Nodes to AWS Services
            {from: 'node1', to: 's3', type: 'solid'},
            {from: 'node1', to: 'secrets', type: 'dashed'},
            {from: 'node1', to: 'cloudwatch', type: 'dashed'},

            // ECR to Nodes
            {from: 'ecr', to: 'node1', type: 'dashed'},

            // Audit
            {from: 'alb', to: 'cloudtrail', type: 'dashed'}
        ];

        // Draw links
        const linkGroup = svg.insert('g', '.node')
            .attr('class', 'links');

        links.forEach(link => {
            const source = nodes.find(n => n.id === link.from);
            const target = nodes.find(n => n.id === link.to);

            if (!source || !target) return;

            const x1 = source.x + source.width / 2;
            const y1 = source.y + source.height / 2;
            const x2 = target.x + target.width / 2;
            const y2 = target.y + target.height / 2;

            // Calculate path with bezier curves
            const path = d3.path();
            path.moveTo(x1, y1);

            const dx = x2 - x1;
            const dy = y2 - y1;

            if (Math.abs(dx) > Math.abs(dy)) {
                // Horizontal curve
                const cx = x1 + dx / 2;
                path.quadraticCurveTo(cx, y1, cx, (y1 + y2) / 2);
                path.quadraticCurveTo(cx, y2, x2, y2);
            } else {
                // Vertical curve
                const cy = y1 + dy / 2;
                path.quadraticCurveTo(x1, cy, (x1 + x2) / 2, cy);
                path.quadraticCurveTo(x2, cy, x2, y2);
            }

            linkGroup.append('path')
                .attr('class', `link ${link.type}`)
                .attr('d', path.toString())
                .attr('marker-end', `url(#arrow${link.type === 'dashed' ? '-dashed' : ''})`);
        });

        // Add AWS logo text
        svg.append('text')
            .attr('class', 'aws-icon')
            .attr('x', 1400)
            .attr('y', 840)
            .attr('text-anchor', 'end')
            .text('Powered by AWS');

        // Download diagram as PNG
        async function downloadDiagram() {
            const button = document.querySelector('.download-btn');
            const originalText = button.textContent;
            button.textContent = 'â³ Generating...';
            button.disabled = true;

            try {
                button.style.display = 'none';
                await new Promise(resolve => setTimeout(resolve, 100));

                const diagram = document.querySelector('#diagram');
                const canvas = await html2canvas(diagram, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    useCORS: true,
                    allowTaint: true
                });

                button.style.display = '';

                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'knowledgeweaver-aws-architecture.png';
                    a.click();
                    URL.revokeObjectURL(url);

                    button.textContent = 'âœ… Downloaded!';
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.disabled = false;
                    }, 2000);
                });
            } catch (error) {
                console.error('Download failed:', error);
                button.style.display = '';
                button.textContent = 'âŒ Failed';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.disabled = false;
                }, 2000);
            }
        }
    </script>
</body>
</html>
